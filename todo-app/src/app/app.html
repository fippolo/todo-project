<mat-toolbar class="top-bar">
  <div class="brand">
    <span class="app-title">Dayline</span>
    <span class="app-subtitle">Priority-first 24-hour flow</span>
  </div>
</mat-toolbar>

<main class="shell">
  <section class="timeline-card">
    <div class="timeline-header">
      <div>
        <h2>24-hour bar</h2>
        <p>Tasks sorted by priority, then alphabetical.</p>
      </div>
      <div class="start-control">
        <span class="label">First task starts</span>
        <span class="value">{{ formatTime(startMinutes()) }}</span>
      </div>
    </div>

    <div class="timeline-bar">
      <div
        class="timeline-indicator start"
        [style.left.%]="(startMinutes() / 1440) * 100"
      >
        <span>Start</span>
      </div>
      <div class="timeline-indicator now" [style.left.%]="(nowMinutes() / 1440) * 100">
        <span>Now</span>
      </div>

      @for (segment of timelineSegments(); track segment.id) {
        <div
          class="timeline-segment"
          [class.rest]="segment.isRest"
          [class.completed]="segment.status === 'completed'"
          [class.failed]="segment.status === 'failed'"
          [style.left.%]="segment.left"
          [style.width.%]="segment.width"
          [style.--delay]="segment.delay"
          matTooltip="{{ segment.title }} â€¢ {{ formatDuration(segment.durationMinutes) }}"
        >
          <span>{{ segment.label }}</span>
        </div>
      }
    </div>

    <div class="timeline-footer">
      <div class="ticks">
        <span>00:00</span>
        <span>06:00</span>
        <span>12:00</span>
        <span>18:00</span>
        <span>24:00</span>
      </div>
      <div class="start-slider">
        <mat-slider min="0" max="1439" step="1" [displayWith]="formatTime" discrete>
          <input
            matSliderThumb
            [value]="startMinutes()"
            (valueChange)="setStartMinutes($event)"
          />
        </mat-slider>
        <button mat-stroked-button type="button" class="sync-button" (click)="syncStartToNow()">
          Sync to now
        </button>
      </div>
      @if (overbooked()) {
        <div class="overbooked">
          <mat-icon>warning</mat-icon>
          Tasks exceed 24 hours. Consider shorter estimates or rest time.
        </div>
      }
    </div>
  </section>

  <section class="content-grid">
    <div class="task-column">
      <div class="section-header">
        <h2>Tasks</h2>
        <span class="count">{{ sortedTasks().length }} total</span>
      </div>

      @if (sortedTasks().length === 0) {
        <mat-card class="empty-state">
          <mat-icon>playlist_add</mat-icon>
          <h3>No tasks yet</h3>
          <p>Add a task to see it appear on the 24-hour bar.</p>
        </mat-card>
      } @else {
        <div class="task-list" cdkDropList (cdkDropListDropped)="dropTask($event)">
          @for (task of sortedTasks(); track task.id; let i = $index) {
            <mat-card class="task-card" cdkDrag [style.--delay]="(i * 80) + 'ms'">
              <div class="task-top">
                <div class="task-title" [class.failed-text]="task.status === 'failed'">
                  @if (task.status === 'completed') {
                    <mat-icon class="status-icon completed">check_circle</mat-icon>
                  }
                  @if (task.status === 'failed') {
                    <mat-icon class="status-icon failed">cancel</mat-icon>
                  }
                  <span>{{ task.title }}</span>
                </div>
                <div class="task-actions">
                  <button
                    mat-icon-button
                    class="drag-handle"
                    cdkDragHandle
                    aria-label="Reorder task"
                  >
                    <mat-icon>drag_indicator</mat-icon>
                  </button>
                  <button mat-icon-button (click)="editTask(task)" aria-label="Edit task">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeTask(task)"
                    aria-label="Remove task"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              @if (task.description) {
                <p class="task-description" [class.failed-text]="task.status === 'failed'">
                  {{ task.description }}
                </p>
              }
              <div class="task-meta">
                <mat-chip-set>
                  <mat-chip>Priority {{ task.priority }}</mat-chip>
                  <mat-chip>
                    {{
                      task.estimateMinutes
                        ? formatDuration(task.estimateMinutes)
                        : (task.isRest ? 'Auto rest' : 'Auto time')
                    }}
                  </mat-chip>
                  @if (task.isRest) {
                    <mat-chip class="rest-chip">Rest</mat-chip>
                  }
                </mat-chip-set>
                <mat-button-toggle-group
                  class="status-toggle"
                  [value]="task.status"
                  (change)="setStatus(task, $event.value)"
                  aria-label="Task status"
                >
                  <mat-button-toggle value="uncompleted">Todo</mat-button-toggle>
                  <mat-button-toggle value="completed">Done</mat-button-toggle>
                  <mat-button-toggle value="failed">Failed</mat-button-toggle>
                </mat-button-toggle-group>
              </div>
            </mat-card>
          }
        </div>
      }
    </div>

    <div class="form-column">
      <mat-card class="editor-card">
        <div class="editor-header">
          <h2>{{ editingId() ? 'Edit task' : 'Add new task' }}</h2>
          <p>{{ editingId() ? 'Update fields and save.' : 'Capture your next priority.' }}</p>
        </div>
        <form class="task-form" [formGroup]="form" (ngSubmit)="saveTask()">
          <mat-form-field appearance="outline">
            <mat-label>Title</mat-label>
            <input matInput formControlName="title" placeholder="e.g. Review release notes" />
            @if (form.controls.title.touched && form.controls.title.invalid) {
              <mat-error>Title is required.</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              rows="3"
              placeholder="Optional context or notes"
            ></textarea>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Priority</mat-label>
              <input matInput type="number" formControlName="priority" min="1" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Estimate (minutes)</mat-label>
              <input matInput type="number" formControlName="estimateMinutes" min="0" step="5" />
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option value="uncompleted">Uncompleted</mat-option>
              <mat-option value="completed">Completed</mat-option>
              <mat-option value="failed">Failed</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-slide-toggle formControlName="isRest">Rest time block</mat-slide-toggle>

          <div class="form-actions">
            @if (editingId()) {
              <button mat-stroked-button type="button" (click)="cancelEdit()">Cancel</button>
            }
            <button mat-flat-button color="primary" type="submit">
              {{ editingId() ? 'Save changes' : 'Add task' }}
            </button>
          </div>
        </form>
      </mat-card>
    </div>
  </section>
</main>

<footer class="app-footer">
  <a href="https://github.com/fippolo/todo-project" target="_blank" rel="noopener">
    View source on GitHub
  </a>
</footer>
